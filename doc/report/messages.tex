\section{Messages}
In this section, the format of all exchanged messages is reported. 
Each message is represented as a table where one cell corresponds to one 
byte. Fields are aligned in order to improve readability, thus empty spaces
do not represent real empty parts of the message. Real messages are always 
``contiguous''.

\subsection{\texttt{SECURE MESSAGE}}
Carries an encrypted message.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{0}}
		& \bitbox{16}{\texttt{tag (16 bytes)}} \\
		& \bitbox{32}{\texttt{ciphertext}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{ciphertext}}
	\end{bytefield}
	\caption{Secure message format}
\end{figure}
\begin{itemize}
	\item len: length of the message
	\item 0: type of the message (SECURE\_MESSAGE)
	\item ciphertext: encrypted message
	\item tag: aes\_gcm verification tag
\end{itemize}

\subsection{\texttt{CLIENT HELLO}}
Sent by a client when a new connection has to be started.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{1}}
		& \bitbox{4}{\texttt{nonce}} \\
		& \bitbox{16}{\texttt{client id (16 bytes)}}
		& \bitbox{16}{\texttt{server id (16 bytes)}}\\
		& \bitbox{32}{\texttt{client ephemeral key}} \\
		& \bitbox{32}{\texttt{...}}\\
		& \bitbox{32}{\texttt{client ephemeral key}}
	\end{bytefield}
	\caption{Client hello message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 1: type of the message (CLIENT\_HELLO)
	\item nonce: random integer generated by the client
	\item client id: identifier of the client, i.e. his username as a string
		padded with 0s (padding is not required here but is kept for coherence 
		with other messages).
	\item server id: identifier of the server. The identifier of the game server
		is the string \texttt{server}.
	\item eph key: DH ephemeral key of the client
\end{itemize}

\subsection{\texttt{SERVER HELLO}}
Server reply to a \texttt{SERVER HELLO} message.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{2}}
		& \bitbox{4}{\texttt{nonce}} \\
		& \bitbox{16}{\texttt{server id (16 bytes)}}
		& \bitbox{16}{\texttt{client id (16 bytes)}} \\
		& \bitbox{32}{\texttt{server ephemeral key}} \\
		& \bitbox{32}{\texttt{...}}\\
		& \bitbox{32}{\texttt{server ephemeral key}} \\
		\begin{rightwordgroup}{DS}
			\bitbox{32}{\texttt{digital signature}} \\
			\bitbox{32}{...} \\
			\bitbox{32}{\texttt{digital signature}}
		\end{rightwordgroup}
	\end{bytefield}
	\caption{Server hello message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 2: type of the message (SERVER\_HELLO)
	\item nonce: random integer generated by the server
	\item server id: identifier of the server
	\item client id: identifier of the client
	\item digital signature: digital signature of the server
\end{itemize}

\subsection{\texttt{CLIENT VERIFY}}
Client sends its digital signature.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{3}} \\
		\begin{rightwordgroup}{DS}
			\bitbox{32}{\texttt{digital signature}} \\
			\bitbox{32}{...} \\
			\bitbox{32}{\texttt{digital signature}}
		\end{rightwordgroup}
	\end{bytefield}
	\caption{Client verify message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 3: type of the message (CLIENT\_VERIFY)
	\item digital signature: digital signature of the client
\end{itemize}

\subsection{\texttt{START GAME PEER}}
Message sent when an user wants to start a game with another peer.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-2} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{4}}
	\end{bytefield}
	\caption{Start game peer message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 4: type of the message (START\_GAME\_PEER)
\end{itemize}

\subsection{\texttt{MOVE}}
Message containing the next move of the user
\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-3} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{5}}
		& \bitbox{1}{\texttt{C}}
	\end{bytefield}
	\caption{Move message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 4: type of the message (MOVE)
	\item \texttt{C}: chosen column where to insert the token
\end{itemize}


\subsection{\texttt{REGISTER}}
Registers user to the server.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-18} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{6}}
		& \bitbox{16}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Register message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 6: type of the message (REGISTER)
	\item username: username of the user. It is not necessary to specify the 
		username again since user connections are already authenticated
		but it's kept for compatibility with the non-secure implementation.
\end{itemize}

\subsection{\texttt{CHALLENGE}}
Sends a challenge to a user.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{7}}
		& \bitbox{32}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Challenge message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 7: type of the message (CHALLENGE)
	\item username: adversary to challenge. Here padding is useful to prevent 
		leaking any kind of information about the challenged user.
\end{itemize}

\subsection{\texttt{GAME END}}
Signals end of the match.
\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-2} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{8}} 
	\end{bytefield}
	\caption{Game end message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 8: type of the message (GAME\_END)
\end{itemize}

\subsection{\texttt{USERS LIST}}
Transports the list of all the active users.
\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{9}} \\
		& \bitbox{32}{\texttt{list of usernames}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{list of usernames}}
	\end{bytefield}
	\caption{Users list message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 9: type of the message (USERS\_LIST)
	\item list of usernames: comma separated list of usernames padded at 
		multiple of 16 bytes to prevent an eavesdropper to guess online users 
		by measuring the message length.
\end{itemize}

\subsection{\texttt{USERS LIST REQUEST}}
Requests the list of all the active users
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-6} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{10}}
		& \bitbox{4}{\texttt{offset}}
	\end{bytefield}
	\caption{Users list request message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 10: type of the message (USERS\_LIST)
	\item offset: offset for the list of users we want to receive (where to start from)
\end{itemize}

\subsection{\texttt{CHALLENGE FORWARD}}
Message forwarded from the server to the peer to signal an incoming challenge.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-18} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{11}}
		& \bitbox{16}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Challenge forward message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 11: type of the message (CHALLENGE\_FORWARD)
	\item username: username of the challenger
\end{itemize}

\subsection{\texttt{CHALLENGE RESPONSE}}
Message carrying the response to a challenge.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-21} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{12}}
		& \bitbox{1}{\texttt{R}} 
		& \bitbox{2}{\texttt{LP}}
		& \bitbox{16}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Challenge response message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 12: type of the message (CHALLENGE\_RESPONSE)
	\item \texttt{R} (response): response accepted or refused
	\item \texttt{LP} (listen port): if accepted, the port on which the user is listening
	\item username: username of the challenger
\end{itemize}

\subsection{\texttt{GAME CANCEL}}
Message through which the server forwards a challenge rejectal or another event that caused the game to be canceled.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-18} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{13}}
		& \bitbox{16}{\texttt{username (16 bytes)}} 
	\end{bytefield}
	\caption{Game cancel message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 13: type of the message (GAME\_CANCEL)
	\item username: username of the challenger
\end{itemize}

\subsection{\texttt{GAME START}}
Message through which the server makes a new game start between two peers. Sent from the server to the peers.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{14}}
		& \bitbox{6}{\texttt{peer addr}}
		& \bitbox{16}{\texttt{username (16 bytes)}}  \\
		& \bitbox{32}{\texttt{peer certificate}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{peer certificate}}
	\end{bytefield}
	\caption{Game start message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 14: type of the message (GAME\_START)
	\item peer addr: listening address and port (sockaddr\_in) of the peer
	\item username: username of the peer
	\item peer certificate: certificate of the peer
\end{itemize}

\subsection{\texttt{CERTIFICATE REQUEST}}
Used by a client to request the server certificate.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-2} \\
		\bitbox{2}{\texttt{len}} 
		& \bitbox{1}{\texttt{15}}
	\end{bytefield}
	\caption{Certificate request message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 15: type of the message (CERTIFICATE\_REQUEST)
\end{itemize}

\subsection{\texttt{CERTIFICATE}}
Server response to a \texttt{CERTIFICATE REQUEST} message.

\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{4}{\texttt{len}} 
		& \bitbox{1}{\texttt{16}} \\
		& \bitbox{32}{\texttt{certificate}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{certificate}}
	\end{bytefield}
	\caption{Certificate response message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 16: type of the message (CERTIFICATE)
	\item certificate: server certificate
\end{itemize}

