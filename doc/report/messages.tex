\section{Messages}
\subsection{\texttt{SECURE MESSAGE}}
Carries an encrypted message.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{0}} 
		& \bitbox{8}{\texttt{ciphertext}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{ciphertext}} \\
		& \bitbox{32}{\texttt{tag (16 bytes)}}
	\end{bytefield}
	\caption{Secure message format}
\end{figure}
\begin{itemize}
	\item len: length of the message
	\item 0: type of the message (SECURE\_MESSAGE)
	\item ciphertext: encrypted message
	\item tag: aes\_gcm verification tag
\end{itemize}

\subsection{\texttt{CLIENT HELLO}}
Sent by a client when a new connection has to be started.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{1}} \\
		& \bitbox{32}{\texttt{nonce}} \\
		& \bitbox{32}{\texttt{client id (16 bytes)}} \\
		& \bitbox{32}{\texttt{server id (16 bytes)}} \\
		& \bitbox{32}{\texttt{eph key}} \\
		& \bitbox{32}{\texttt{...}}\\
		& \bitbox{32}{\texttt{eph key}}
	\end{bytefield}
	\caption{Client hello message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 1: type of the message (CLIENT\_HELLO)
	\item nonce: random integer generated by the client
	\item client id: identifier of the client
	\item server id: identifier of the server
	\item eph key: DH ephemeral key of the client
\end{itemize}

\subsection{\texttt{SERVER HELLO}}
Server reply to a \texttt{SERVER HELLO} message.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{2}} \\
		& \bitbox{32}{\texttt{nonce}} \\
		& \bitbox{32}{\texttt{server id (16 bytes)}} \\
		& \bitbox{32}{\texttt{client id (16 bytes)}} \\
		\begin{rightwordgroup}{DS}
			\bitbox{32}{\texttt{digital signature}} \\
			\bitbox{32}{...} \\
			\bitbox{32}{\texttt{digital signature}}
		\end{rightwordgroup}
	\end{bytefield}
	\caption{Server hello message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 2: type of the message (SERVER\_HELLO)
	\item nonce: random integer generated by the server
	\item server id: identifier of the server
	\item client id: identifier of the client
	\item digital signature: digital signature of the server
\end{itemize}

\subsection{\texttt{CLIENT VERIFY}}
Client sends its digital signature.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{3}} \\
		\begin{rightwordgroup}{DS}
			\bitbox{32}{\texttt{digital signature}} \\
			\bitbox{32}{...} \\
			\bitbox{32}{\texttt{digital signature}}
		\end{rightwordgroup}
	\end{bytefield}
	\caption{Client verify message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 3: type of the message (CLIENT\_VERIFY)
	\item digital signature: digital signature of the client
\end{itemize}

\subsection{\texttt{START GAME PEER}}
Message sent when an user wants to start a game with another peer.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{16}
		\bitheader{0-23} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{4}}
	\end{bytefield}
	\caption{Start game peer message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 4: type of the message (START\_GAME\_PEER)
\end{itemize}

\subsection{\texttt{MOVE}}
Message containing the next move of the user
\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{16}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{5}}
		& \bitbox{8}{\texttt{column}}
	\end{bytefield}
	\caption{Move message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 4: type of the message (MOVE)
	\item column: chosen column where to insert the token
\end{itemize}


\subsection{\texttt{REGISTER}}
Registers user to the server.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{6}} \\
		& \bitbox{32}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Register message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 6: type of the message (REGISTER)
	\item username: chosen username, min 3 max 16 char.
\end{itemize}

\subsection{\texttt{CHALLENGE}}
Sends a challenge to a user.
\begin{figure}[h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{16}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{7}} \\
		& \bitbox{32}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Challenge message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 7: type of the message (CHALLENGE)
	\item username: adversary to challenge.
\end{itemize}

\subsection{\texttt{GAME END}}
Signals end of the match.
\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{16}
		\bitheader{0-23} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{8}} 
	\end{bytefield}
	\caption{Game end message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 8: type of the message (GAME\_END)
\end{itemize}

\subsection{\texttt{USERS LIST}}
Transports the list of all the active users.
\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{9}}
		& \bitbox{8}{\texttt{usernames list}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{usernames list}}
	\end{bytefield}
	\caption{Users list message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 9: type of the message (USERS\_LIST)
\end{itemize}

\subsection{\texttt{USERS LIST REQUEST}}
Requests the list of all the active users
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{10}} \\
		& \bitbox{32}{\texttt{offset}}
	\end{bytefield}
	\caption{Users list request message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 10: type of the message (USERS\_LIST)
	\item offset: offset for the list of users we want to receive (where to start from)
\end{itemize}

\subsection{\texttt{CHALLENGE FORWARD}}
Message forwarded from the server to the peer to signal an incoming challenge.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{11}} \\
		& \bitbox{32}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Challenge forward message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 11: type of the message (CHALLENGE\_FORWARD)
	\item username: username of the challenger
\end{itemize}

\subsection{\texttt{CHALLENGE RESPONSE}}
Message carrying the response to a challenge.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{12}}
		& \bitbox{8}{\texttt{response}} \\
		& \bitbox{16}{\texttt{listen port}} \\
		& \bitbox{32}{\texttt{username (16 bytes)}}
	\end{bytefield}
	\caption{Challenge response message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 12: type of the message (CHALLENGE\_RESPONSE)
	\item response: response accepted or refused
	\item listen port: if accepted, the port on which the user is listening
	\item username: username of the challenger
\end{itemize}

\subsection{\texttt{GAME CANCEL}}
Message through which the server forwards a challenge rejectal or another event that caused the game to be canceled.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{13}} \\
		& \bitbox{32}{\texttt{username (16 bytes)}} 
	\end{bytefield}
	\caption{Game cancel message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 13: type of the message (GAME\_CANCEL)
	\item username: username of the challenger
\end{itemize}

\subsection{\texttt{GAME START}}
Message through which the server makes a new game start between two peers. Sent from the server to the peers.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{14}}
		& \bitbox{8}{\texttt{socket address}} \\
		& \bitbox{32}{\texttt{socket address}} \\
		& \bitbox{8}{\texttt{socket address}}
		& \bitbox{24}{\texttt{username (16 bytes)}}  \\
		& \bitbox{32}{\texttt{username (16 bytes)}}  \\
		& \bitbox{32}{\texttt{certificate}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{certificate}}
	\end{bytefield}
	\caption{Game start message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 14: type of the message (GAME\_START)
	\item socket address: listening address and port (sockaddr\_in) of the peer
	\item username: username of the peer
	\item certificate: certificate of the peer
\end{itemize}

\subsection{\texttt{CERTIFICATE REQUEST}}
Used by a client to request the server certificate.
\begin{figure}[!h]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-23} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{15}}
	\end{bytefield}
	\caption{Certificate request message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 15: type of the message (CERTIFICATE\_REQUEST)
\end{itemize}

\subsection{\texttt{CERTIFICATE}}
Server response to a \texttt{CERTIFICATE REQUEST} message.

\begin{figure}[!htbp]
	\centering
	\begin{bytefield}[bitwidth=1.1em]{32}
		\bitheader{0-31} \\
		\bitbox{16}{\texttt{len}} 
		& \bitbox{8}{\texttt{16}} \\
		& \bitbox{32}{\texttt{certificate}} \\
		& \bitbox{32}{\texttt{...}} \\
		& \bitbox{32}{\texttt{certificate}}
	\end{bytefield}
	\caption{Certificate response message format}
\end{figure}

\begin{itemize}
	\item len: length of the message
	\item 16: type of the message (CERTIFICATE)
	\item certificate: server certificate
\end{itemize}

